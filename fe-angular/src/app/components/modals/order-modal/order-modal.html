@if (isOpen()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 p-6">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-4">Criar Novo Pedido</h2>

      @if (error()) {
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-4">
          <p class="text-red-800 dark:text-red-200 text-sm">{{ error() }}</p>
        </div>
      }

      <form (ngSubmit)="onSubmit()" class="space-y-4">
        <mat-form-field class="w-full">
          <mat-label>Cliente</mat-label>
          <mat-select [(ngModel)]="formData.customer_id" name="customer_id" required>
            @for (customer of customers(); track customer.id) {
              <mat-option [value]="customer.id">
                {{ customer.name }} ({{ customer.email }})
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field class="w-full">
          <mat-label>Produto</mat-label>
          <mat-select [(ngModel)]="formData.product_id" [(value)]="selectedProductId" name="product_id" (selectionChange)="updateTotal()" required>
            @for (product of products(); track product.id) {
              <mat-option [value]="product.id">
                {{ product.name }} - {{ product.price | currency:'BRL' }}
                @if (product.stock_quantity !== undefined) {
                  (Estoque: {{ product.stock_quantity }})
                }
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        @if (selectedProduct) {
          <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-3">
            <p class="text-sm text-blue-800 dark:text-blue-200">
              <strong>Preço unitário:</strong> {{ selectedProduct.price | currency:'BRL' }}
            </p>
            @if (selectedProduct.stock_quantity !== undefined) {
              <p class="text-sm text-blue-800 dark:text-blue-200 mt-1">
                <strong>Estoque disponível:</strong> {{ selectedProduct.stock_quantity }}
              </p>
            }
          </div>
        }

        <mat-form-field class="w-full">
          <mat-label>Quantidade</mat-label>
          <input matInput type="number" [(ngModel)]="formData.quantity" name="quantity" min="1" (ngModelChange)="updateTotal()" required>
        </mat-form-field>

        <mat-form-field class="w-full">
          <mat-label>Total (R$)</mat-label>
          <input matInput type="number" [(ngModel)]="formData.total_amount" name="total_amount" readonly>
        </mat-form-field>

        <div class="flex gap-3 pt-4">
          <button mat-raised-button color="primary" type="submit" [disabled]="isLoading()">
            {{ isLoading() ? 'Criando...' : 'Criar Pedido' }}
          </button>
          <button mat-button type="button" (click)="onClose()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
}
